$(document).ready(function() {
	$('#show-hdr').click(function(e) {
		e.preventDefault();
		$(this).toggleClass('i-close-active').toggleClass('i-settings');
		$('.hdr').toggleClass('hdr-out');
		return $('.hdr-controls').toggle().toggleClass('flipInY animated');
	});

	$('#show-grunt').click(function(e) {
		e.preventDefault();
		$(this).toggleClass('i-close-active');
		$('#range-grunt').find('input').focus();
		return $('.range-grunt').toggle().toggleClass('flipInY animated');
	});


/**********************/
/******* HERDS ********/
/**********************/

	$('.herds').backstretch(['<%= asset_url 'herds-bg.jpg' %>']);

	if($('body').hasClass('herds show')) {
		$.getJSON('/herds/' + $('#chat_list').attr('data-herdid') + '.json?', function(data){
			$.each(data.grunts, function(key, val){
				$('#chat_list').append(yakfunc.messageDisplay(val))
			});
		});
		var evtSource;
		evtSource = new EventSource('/herds/' + $('#chat_list').attr('data-herdid') + '/stream');
		evtSource.onmessage = function(e) {
			var resp;
			resp = JSON.parse(e.data);
			$('#chat_list').prepend(yakfunc.messageDisplay(resp.data));
			var latest_grunt = parseFloat($('#grunt_count').text())
			latest_grunt++;
			$('#grunt_count').text(latest_grunt)
			if(parseInt($.cookie('active_yak')) !== resp.data.user_id) {
				yakfunc.notify((resp.data.user_name + ': ' + resp.data.message),$('#chat_list').attr('data-herdid'),'Yaaak', window.location.href)
			}
		};
		evtSource.onopen = function(e) {
			return console.log('open');
		};
		evtSource.onerror = function(e) {
			console.log('error');
			//return evtSource.close();
		};
		evtSource.onclose = function(e) {
			return console.log('close');
		};
		window.onbeforeunload = function() {
			evtSource.close()
		};
	}

	$('#chat_list').on('click', '.message', function(e) {
		var retrieveYakData, targetedMessage;
		$('#chat_list').find('.popup').remove();
		console.log($('#chat_list').find('.popup'))
		retrieveYakData = $.getJSON('/yaks/' + $(this).children('.yak').attr('data-userid') + '.json', function(data){
			$('.popup .user_name').text(data.user_name)
			$('.popup .grunt_count').text(data.grunt_count)
			$('.popup .user_color').text(data.user_color)
			$('.popup .short_user_name').text(data.short_user_name)
			$('.popup .last_grunt').text(data.last_grunt)
		});
		targetedMessage = $(this);
		retrieveYakData.complete(function(){
			var popup = $('.popup').html();
			$(targetedMessage).prepend('<div class="popup">' + popup + '</div>')
			$(targetedMessage).children('.popup').fadeIn();

		});
	});
	$('.popup').click(function(){
		$(this).fadeOut();
	})

	var pagination = 2;
	$('#chat_list').scroll(function(e){
		console.log($('#chat_list')[0].scrollHeight);
		console.log($('#chat_list').scrollTop() + 580);
		if($('#chat_list')[0].scrollHeight == ($('#chat_list').scrollTop() + 580) ){
			$.getJSON('/herds/' + $('#chat_list').attr('data-herdid') + '.json?page=' + pagination, function(data){
				$.each(data.grunts, function(key, val){
					$('#chat_list').append(yakfunc.messageDisplay(val))
				});
			});
		}
	});

/**********************/
/******* GRUNTS *******/
/**********************/

	$('#grunt_message').focus();
	$("#new_grunt").submit(function(e) {
		e.preventDefault();
		$.ajax({
			url: $('#new_grunt').attr('action'),
			type: "POST",
			dataType: "json",
			data: $('#new_grunt').serialize(),
			success: function(msg) {
				$('#grunt_message').val('')
					if(!$('body').hasClass('herds')) {
							window.location = "/herds/" + msg.herd_id;
					}
			},
			error: function(xhr, status) {
				return $('body').html(xhr.responseText);
			}
		});
	});

	$("#updateName").submit(function(e) {
		e.preventDefault();
		$.ajax({
			url: '/yaks/'+parseInt($.cookie('active_yak')),
			type: "put",
			dataType: "json",
			data: 'name='+encodeURIComponent($('#newName').val()),
			success: function(msg) {
					$(this).toggleClass('i-close-active').toggleClass('i-settings');
					$('.hdr').toggleClass('hdr-out');
					return $('.hdr-controls').toggle().toggleClass('flipInY animated');
			},
			error: function(xhr, status) {
				return $('body').html(xhr.responseText);
			}
		});
	});
});
