
function messageDisplay(info){
  return '<li><div class="message"><div class="yak" data-userid="' + info.user_id + '" data-date="' + info.created_at + '" style="background:' + info.user_color + '">' + info.user_name + '</div><div class="message-content"><p>' + info.message + '</p><span class="tab"></span></div></div></li>'
}
$(document).ready(function() {

  $('select').selectpicker();

  $('#show-hdr').click(function(e) {
    e.preventDefault();
    $(this).toggleClass('i-close-active').toggleClass('i-settings');
    $('.hdr').toggleClass('hdr-out');
    return $('.hdr-controls').toggle().toggleClass('flipInY animated');
  });

  $('#show-grunt').click(function(e) {
    e.preventDefault();
    $(this).toggleClass('i-close-active');
    $('#range-grunt').find('input').focus();
    return $('.range-grunt').toggle().toggleClass('flipInY animated');
  });
  $('.herds').backstretch(['<%= asset_url 'herds-bg.jpg' %>']);

/**********************/
/******* HERDS ********/
/**********************/

  function notify(content,tags,title, url){
    if(window.webkitNotifications){
      var havePermission = window.webkitNotifications.checkPermission();
      if (havePermission == 0) {
        var notification = window.webkitNotifications.createNotification("<%= asset_url 'favicon.png' %>",title,content);
	    notification.onclick = function () {
		  window.open(url);
		  notification.close();
		}
   		notification.show();
   		setTimeout(function() {
   			notification.cancel();
   		}, 2500)
   	  } else {
   	    window.webkitNotifications.requestPermission();
   	  }
    } else {
      if (Notification && Notification.permission === "granted") {
   	    var notification = new Notification(content, {tag: tags });

   		setTimeout(function() {
   			notification.close();
   		}, 3000)
   	  } else if (Notification && Notification.permission !== 'denied') {
   	    Notification.requestPermission(function (permission) {
   	      if(!('permission' in Notification)) {
   		    Notification.permission = permission;
   		  }
   		  if (permission === "granted") {
   		    var notification = new Notification(content, {tag: tags});
   		    setTimeout(function() {
   			  notification.close();
   		    }, 3000)
   		   }
   	    });
   	  }
    };
  }

  if($('body').hasClass('herds show')) {
  	$.getJSON('/herds/' + $('#chat_list').attr('data-herdid') + '.json?limit=0', function(data){
  		$.each(data.grunts, function(key, val){
  			$('#chat_list').append(messageDisplay(val))
  		});
  	});
    var evtSource;
    evtSource = new EventSource('/herds/' + $('#chat_list').attr('data-herdid') + '/stream');
    evtSource.onmessage = function(e) {
      var resp;
      resp = JSON.parse(e.data);
      $('#chat_list').prepend(messageDisplay(resp.data));
      var latest_grunt = parseFloat($('#grunt_count').text())
      latest_grunt++;
      $('#grunt_count').text(latest_grunt)
      if(parseInt($.cookie('active_yak')) !== resp.data.user_id) {
      	notify((resp.data.user_name + ': ' + resp.data.message),$('#chat_list').attr('data-herdid'),'Yaaak', window.location.href)
      }
    };
    evtSource.onopen = function(e) {
      return console.log('open');
    };
    evtSource.onerror = function(e) {
      console.log('error');
      return evtSource.close();
    };
	evtSource.onclose = function(e) {
      return console.log('close');
    };
    window.onbeforeunload = function() {
      evtSource.close()
    };
  }

  $('#chat_list').on('click', '.message', function(e) {
    $.getJSON('/yaks/' + $(this).children('.yak').attr('data-userid') + '.json', function(data){
  	  $('.overlay .user_name').text(data.user_name)
  	  $('.overlay .grunt_count').text(data.grunt_count)
  	  $('.overlay .user_color').text(data.user_color)
  	  $('.overlay .short_user_name').text(data.short_user_name)
  	  $('.overlay .last_grunt').text(data.last_grunt)
  	});
  	window.toggle_overlay()
  });

  var pagination = 1;
  $('#chat_list').scroll(function(e){
  	console.log($('#chat_list')[0].scrollHeight);
  	if($('#chat_list')[0].scrollHeight == ($('#chat_list').scrollTop() + 580) ){
  	  $.getJSON('/herds/' + $('#chat_list').attr('data-herdid') + '.json?page=' + pagination, function(data){
  		$.each(data.grunts, function(key, val){
  			$('#chat_list').append(messageDisplay(val))
  		});
      });
    }
  });
  $('.overlay-bg').click(function(){
  	window.toggle_overlay()
  });




/**********************/
/******* GRUNTS *******/
/**********************/
  $('#grunt_message').focus();
  $("#new_grunt").submit(function(e) {
    e.preventDefault();
    $.ajax({
      url: $('#new_grunt').attr('action'),
      type: "POST",
      dataType: "json",
      data: $('#new_grunt').serialize(),
      success: function(msg) {
      	$('#grunt_message').val('')
      	console.log($('#new_grunt').serialize());
      },
      error: function(xhr, status) {
        return $('body').html(xhr.responseText);
      }
    });
  });
  $("#updateName").submit(function(e) {
    e.preventDefault();
    $.ajax({
      url: '/yaks/'+parseInt($.cookie('active_yak')),
      type: "PATCH",
      dataType: "json",
      data: 'name='+encodeURIComponent($('#newName').val()),
      success: function(msg) {
      	console.log('success')
      },
      error: function(xhr, status) {
        return $('body').html(xhr.responseText);
      }
    });
  });
});
