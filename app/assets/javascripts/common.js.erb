
function messageDisplay(info){
  return '<li><div class="message"><div class="yak" data-userid="' + info.user_id + '" data-date="' + info.created_at + '" style="background:' + info.user_color + '">' + info.user_name + '</div><div class="message-content"><p>' + info.message + '</p><span class="tab"></span></div></div></li>'
}
$(document).ready(function() {

  $('select').selectpicker();

  $('#show-hdr').click(function(e) {
    e.preventDefault();
    $(this).toggleClass('i-close-active').toggleClass('i-settings');
    $('.hdr').toggleClass('hdr-out');
    return $('.hdr-controls').toggle().toggleClass('flipInY animated');
  });

  $('#show-grunt').click(function(e) {
    e.preventDefault();
    $(this).toggleClass('i-close-active');
    $('#range-grunt').find('input').focus();
    $('.range-grunt').toggleClass('grunt-out');
    $('#rumble2013').toggle();
    return $('.grunt-controls').toggle().toggleClass('flipInY animated');
  });

  $('.herds').backstretch(['<%= asset_url 'herds-bg.jpg' %>']);

/**********************/
/******* HERDS ********/
/**********************/
  function notify(content,tags,title, url){
    if(window.webkitNotifications){
      var havePermission = window.webkitNotifications.checkPermission();
      if (havePermission == 0) {
        var notification = window.webkitNotifications.createNotification("<%= asset_url 'favicon.png' %>",title,content);
	    notification.onclick = function () {
		  window.open(url);
		  notification.close();
		}
   		notification.show();
   	  } else {
   	    window.webkitNotifications.requestPermission();
   	  }
    } else {
      if (Notification && Notification.permission === "granted") {
   	    var notification = new Notification(content, {tag: tags });
   	  } else if (Notification && Notification.permission !== 'denied') {
   	    Notification.requestPermission(function (permission) {
   	      if(!('permission' in Notification)) {
   		    Notification.permission = permission;
   		  }
   		  if (permission === "granted") {
   		   var notification = new Notification(content, {tag: tags});
   		  }
   	    });
   	  }
    };
  }
  if($('body').hasClass('herds show')) {
    var evtSource;
    evtSource = new EventSource('/herds/1/stream');

    evtSource.onmessage = function(e) {
      var resp;
      resp = JSON.parse(e.data);
      $('#chat_list').prepend(messageDisplay(resp.data));
      notify(resp.data.message,$('#chat_list').attr('data-herdid'),'Yaaak', window.location.href)
      return console.log(resp);
    };
    evtSource.onopen = function(e) {
      return console.log('open');
    };
    evtSource.onerror = function(e) {
      console.log('error');
      return console.log(e);
      evtSource.close();
    };
	evtSource.onclose = function(e) {
      return console.log('close');
    };
    window.onbeforeunload = function() {
      evtSource.close()
    };

    //AJAX in the list
    $.getJSON('/herds/'+$('#chat_list').attr('data-herdid')+'.json', function(data){
      $.each(data.grunts, function(key, val){
  	    $('#chat_list').prepend(messageDisplay(val))
  	  });
    })

  }
  $('.herds .message .yak').click(function(){
  	console.log('lllll')
  	$.getJSON('/yaks/' + $(this).attr('data-userid') + '.json', function(data){
  		$('.overlay .user_name').text(data.user_name)
  		$('.overlay .grunt_count').text(data.grunt_count)
  		$('.overlay .user_color').text(data.user_color)
  		$('.overlay .short_user_name').text(data.short_user_name)
  		$('.overlay .last_grunt').text(data.last_grunt)
  	})
  });

/**********************/
/******* GRUNTS *******/
/**********************/
  $('#grunt_message').focus();
  $("#new_grunt").submit(function(e) {
    e.preventDefault();
    $.ajax({
      url: $('#new_grunt').attr('action'),
      type: "POST",
      dataType: "json",
      data: $('#new_grunt').serialize(),
      success: function(msg) {
      	$('#grunt_message').val('')
      },
      error: function(xhr, status) {
        return $('body').html(xhr.responseText);
      }
    });
  });
});
